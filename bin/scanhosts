#!/bin/bash

if [ "$1" = "--help" -o "$1" = "--h" ] ; then
    echo <<EOF
scanhosts scans the network for grit devices and edits /etc/hosts to reflect found ids (~/grit/id -> ip id #grit-auto in /etc/hosts)
EOF
    exit 0
fi
scan() {
    /bin/rm -rf $HOME/grit/logs/scanhosts.log
    for nets in 192.168.10.0/24
    do
	nmap -sP -PE -PA21,22,23,80,3389 $nets 2>/dev/null | tee -a $HOME/grit/logs/scanhosts.log
    done
}

is_up() {
    prev=""
    while read line
    do 
	if [[ "$line" =~ ^Host\ is\ up ]]
	then
	    if [[ "$prev" =~ ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+) ]]
	    then
		echo ${BASH_REMATCH[0]}
	    fi
	fi
	prev="$line"
    done
}

hosts() {
    while read ip
    do
	for user in ubuntu fit-pc cogburn
	do
	    id=$(ssh -i $HOME/id_grit -o BatchMode=yes -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -o ConnectTimeout=1 $user@$ip "test -f grit/id && cat grit/id" 2>/dev/null)
	    if [ "$id" != "" ] ; then
		echo "$ip $id #grit-auto > /etc/hosts"
		sudo sed -i -e 's/^\([0-9.]\+\|#unknown\)[ \t]\+'"$id"'[ \t]\+#grit-auto[ \t]*$/'"$ip $id #grit-auto"'/' /etc/hosts
		break
	    fi
	done
    done
}

scan | is_up | hosts
