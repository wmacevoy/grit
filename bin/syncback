#!/bin/bash

if [ "$1" = "--help" -o "$1" = "--h" ] ; then
    echo <<EOF
resync synchronizes BACK the files/folders on this system under version control FROM systems described in the rsync lines of the setup/config.csv file
EOF
    exit 0
fi

dir=$(mktemp -d)
trap '/bin/rm -rf $dir' EXIT

cfg() {
    drivers/context drivers/utilities/bin/config --path setup "$@"
}

as_list() {
    sed -e 's/,/ /g'
}

dests=$(cfg '${rsync.dests}' | as_list)
parts=$(cfg '${rsync.parts}' | as_list)

for part in $parts
do
    if [ -f $part ] ; then
	echo $part
	echo $part >> $dir/files
    else
	echo $part/
	( cd $part; git ls-tree -r master --name-only | sed -e "s|^|$part/|" >> $dir/files )
    fi
done

for dest in $dests
do
    echo $dest:
    if echo $dest | grep -q "rsync:"
    then
	args="--compress --timeout 1 --contimeout 1"
    else
	args=""
    fi
    rsync -e "ssh -i $HOME/id_grit" --verbose --progress  --checksum $args --files-from=$dir/files  $dest ./  2>&1 | sed -e "s|^|[$dest] |"
done
